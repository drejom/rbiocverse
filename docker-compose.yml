services:
  manager:
    build: ./manager
    container_name: ${COMPOSE_PROJECT_NAME:-hpc}-app
    pull_policy: always
    restart: unless-stopped

    env_file:
      - path: .env
        required: false

    environment:
      - PUID=${PUID:-568}
      - PGID=${PGID:-568}
      - TZ=${TZ:-America/Los_Angeles}
      - HPC_SSH_USER=${HPC_SSH_USER:-domeally}
      - GEMINI_SSH_HOST=${GEMINI_SSH_HOST:-gemini-login2.coh.org}
      - APOLLO_SSH_HOST=${APOLLO_SSH_HOST:-ppxhpcacc01.coh.org}
      - DEFAULT_HPC=${DEFAULT_HPC:-gemini}
      - CODE_SERVER_PORT=${CODE_SERVER_PORT:-8000}
      - DEFAULT_CPUS=${DEFAULT_CPUS:-2}
      - DEFAULT_MEM=${DEFAULT_MEM:-40G}
      - DEFAULT_TIME=${DEFAULT_TIME:-12:00:00}
      # Data persistence
      - DB_PATH=/data/app.db
      - STATE_FILE=/data/state.json
      - ENABLE_STATE_PERSISTENCE=${ENABLE_STATE_PERSISTENCE:-true}
      # Logging level and component debug
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # DEBUG_COMPONENTS: comma-separated list (vscode,ssh,cache,tunnel,state,ui,rstudio,liveserver) or 'all'
      # Dev: vscode,ssh,cache,tunnel,state,ui (all except rstudio)
      # Prod: empty (all off)
      - DEBUG_COMPONENTS=${DEBUG_COMPONENTS:-}

    volumes:
      # SSH keys copied from studio to TrueNAS (mount to apps user home)
      - /mnt/ssd/docker/hpc-ssh:/home/apps/.ssh:ro
      # Persistent state storage (Phase 1.4)
      # Directory will be created via Dokploy setup scripts
      - data:/data

    expose:
      - 3000   # Manager UI/API (Traefik routes here)
      - 8000   # Internal code-server proxy

    networks:
      - dokploy-network

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  data:
    driver: local

networks:
  dokploy-network:
    external: true
