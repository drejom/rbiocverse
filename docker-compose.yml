# rbiocverse unified monorepo
# Single compose file with env-based configuration for different deployments

services:
  manager:
    image: ghcr.io/drejom/rbiocverse-manager:${MANAGER_VERSION:-latest}
    container_name: ${COMPOSE_PROJECT_NAME:-rbiocverse}-app
    pull_policy: always
    restart: unless-stopped

    env_file:
      - path: .env
        required: false

    environment:
      - PUID=${PUID:-568}
      - PGID=${PGID:-568}
      - TZ=${TZ:-America/Los_Angeles}
      - HPC_SSH_USER=${HPC_SSH_USER:-domeally}
      - GEMINI_SSH_HOST=${GEMINI_SSH_HOST:-gemini-login2.coh.org}
      - APOLLO_SSH_HOST=${APOLLO_SSH_HOST:-ppxhpcacc01.coh.org}
      - DEFAULT_HPC=${DEFAULT_HPC:-gemini}
      - CODE_SERVER_PORT=${CODE_SERVER_PORT:-8000}
      - DEFAULT_CPUS=${DEFAULT_CPUS:-2}
      - DEFAULT_MEM=${DEFAULT_MEM:-40G}
      - DEFAULT_TIME=${DEFAULT_TIME:-12:00:00}
      # Data persistence
      - DB_PATH=/data/app.db
      - STATE_FILE=/data/state.json
      - ENABLE_STATE_PERSISTENCE=${ENABLE_STATE_PERSISTENCE:-true}
      # Logging level and component debug
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # DEBUG_COMPONENTS: comma-separated list (vscode,ssh,cache,tunnel,state,ui,rstudio,liveserver) or 'all'
      - DEBUG_COMPONENTS=${DEBUG_COMPONENTS:-}
      # Authentication
      - JWT_SECRET=${JWT_SECRET}

    volumes:
      # SSH keys mount - path varies by environment
      - ${SSH_MOUNT_PATH:-/mnt/ssd/docker/hpc-ssh}:/home/apps/.ssh:ro
      # Persistent state storage
      - ${DATA_PATH:-data}:/data

    ports:
      - "${MANAGER_PORT:-3000}:3000"
      - "${IDE_PORT:-8000}:8000"

    networks:
      - ${NETWORK_NAME:-default}

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  data:
    # Named volume for persistent state

networks:
  dokploy-network:
    external: true
  default:
