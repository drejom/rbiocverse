<!DOCTYPE html>
<html>
<head>
  <title>RStudio</title>
  <style>
    * { margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    #rstudio-frame {
      width: 100%;
      height: 100%;
      border: none;
    }
    #hpc-menu-frame {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 320px;
      height: 450px;
      border: none;
      z-index: 2147483647;
      pointer-events: auto;
      background: transparent;
    }
    #loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f5f5f5;
      color: #333;
      font-family: system-ui;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div>Loading RStudio...</div>
  </div>
  <iframe id="rstudio-frame" src="" style="display:none;"></iframe>
  <iframe id="hpc-menu-frame" src="/hpc-menu-frame"></iframe>
  <script>
    // Simple RStudio wrapper - just load the direct proxy
    document.addEventListener('DOMContentLoaded', function() {
      const frame = document.getElementById('rstudio-frame');
      const loading = document.getElementById('loading');

      console.log('[RStudio Wrapper] DOMContentLoaded, setting iframe src');

      // RStudio doesn't need cache clearing like VS Code
      frame.src = '/rstudio-direct/';

      frame.onload = function() {
        console.log('[RStudio Wrapper] iframe onload fired');
        loading.style.display = 'none';
        frame.style.display = 'block';
      };

      frame.onerror = function(e) {
        console.error('[RStudio Wrapper] iframe onerror:', e);
      };

      // Fallback: show frame after timeout even if onload doesn't fire
      setTimeout(function() {
        console.log('[RStudio Wrapper] Timeout check - loading visible:', loading.style.display !== 'none');
        if (loading.style.display !== 'none') {
          console.log('[RStudio Wrapper] Forcing frame visible after timeout');
          loading.style.display = 'none';
          frame.style.display = 'block';
        }
      }, 5000);

      // Handle drag messages from menu iframe
      const menuFrame = document.getElementById('hpc-menu-frame');
      window.addEventListener('message', function(e) {
        if (!e.data) return;
        if (e.data.type === 'hpc-menu-drag') {
          const rect = menuFrame.getBoundingClientRect();
          let newTop = rect.top + e.data.dy;
          let newRight = (window.innerWidth - rect.right) - e.data.dx;
          newTop = Math.max(0, Math.min(window.innerHeight - 60, newTop));
          newRight = Math.max(0, Math.min(window.innerWidth - 60, newRight));
          menuFrame.style.top = newTop + 'px';
          menuFrame.style.right = newRight + 'px';
        }
        if (e.data.type === 'hpc-menu-navigate') {
          window.location.href = e.data.url;
        }
      });
    });
  </script>
</body>
</html>
