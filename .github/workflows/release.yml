name: Release

# Coordinated release workflow for rbiocverse monorepo
# Creates GitHub release, builds both container and manager images

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional, auto-generated if empty)'
        required: false
        type: string
      build_container:
        description: 'Build container image'
        type: boolean
        default: true
      build_manager:
        description: 'Build manager image'
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ inputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ inputs.version }} already exists"
            exit 1
          fi

  release:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      tag: v${{ inputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: check-changes
        run: |
          COMMITS=$(git log origin/main..origin/dev --oneline 2>/dev/null | head -20 || echo "")
          if [ -z "$COMMITS" ]; then
            echo "No changes between main and dev - using main branch directly"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes to release:"
            echo "$COMMITS"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create release PR (if changes exist)
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head dev --json number -q '.[0].number' || echo "")

          if [ -z "$EXISTING_PR" ]; then
            CHANGELOG=$(git log origin/main..origin/dev --pretty=format:"- %s (%h)" --no-merges | head -50)

            {
              echo "## Release v${{ inputs.version }}"
              echo ""
              echo "### Changes"
              echo "$CHANGELOG"
              echo ""
              echo "### Release Notes"
              echo "${{ inputs.release_notes || 'See changes above.' }}"
            } > /tmp/pr-body.md

            gh pr create --base main --head dev --title "Release v${{ inputs.version }}" --body-file /tmp/pr-body.md
            EXISTING_PR=$(gh pr list --base main --head dev --json number -q '.[0].number')
          fi

          gh pr merge "$EXISTING_PR" --merge --delete-branch=false

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch origin main
          git checkout main
          git pull origin main

          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

          if [ -n "${{ inputs.release_notes }}" ]; then
            NOTES="${{ inputs.release_notes }}"
          else
            NOTES=$(git log $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "HEAD~20")..HEAD --pretty=format:"- %s" --no-merges | head -30)
          fi

          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes "${NOTES}" \
            --target main

  build-container:
    needs: release
    if: inputs.build_container
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/drejom/rbiocverse
          tags: |
            type=semver,pattern={{version}},value=v${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=v${{ inputs.version }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./container
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-manager:
    needs: release
    if: inputs.build_manager
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/drejom/rbiocverse-manager
          tags: |
            type=semver,pattern={{version}},value=v${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=v${{ inputs.version }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./manager
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  summary:
    needs: [release, build-container, build-manager]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Release summary
        run: |
          echo "## Release v${{ inputs.version }} Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images Built" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_container }}" == "true" ]; then
            echo "- \`ghcr.io/drejom/rbiocverse:${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.build_manager }}" == "true" ]; then
            echo "- \`ghcr.io/drejom/rbiocverse-manager:${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploy with: \`docker compose pull && docker compose up -d\`" >> $GITHUB_STEP_SUMMARY
